<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AQEvent | William & Mary</title>
    <meta name="description" content="Administrative panel for managing event approvals at William & Mary.">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='80'%3E⚙️%3C/text%3E%3C/svg%3E">
</head>
<body>
    <div class="container">
        <!-- W&M Branded Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>⚙️ Admin Panel</h1>
                    <p>Event Management & Approval System</p>
                </div>
                <div class="header-right">
                    <a href="?page=form" class="nav-btn">➕ New Event</a>
                    <a href="?page=calendar" class="nav-btn">📅 Calendar</a>
                    <button class="nav-btn" id="logoutBtn" style="display: none;">🚪 Logout</button>
                </div>
            </div>
        </div>

        <!-- Authentication Required Notice (Shown when not authenticated) -->
        <div id="authRequiredContainer" class="form-container">
            <div class="card" style="max-width: 500px; margin: var(--spacing-xl) auto;">
                <div class="card-header text-center">
                    <h3 class="card-title text-primary">🔐 Admin Authentication Required</h3>
                    <p class="card-subtitle">Please authenticate to access the admin panel</p>
                </div>
                <div class="card-body">
                    <div class="text-center" style="margin-bottom: var(--spacing-lg);">
                        <div style="font-size: 4rem; margin-bottom: var(--spacing-sm);">🏛️</div>
                        <h4 class="text-primary">William & Mary</h4>
                        <p class="text-muted">AQEvent Administration</p>
                    </div>
                    
                    <button class="btn btn-primary btn-lg" id="loginBtn" style="width: 100%;">
                        🔑 Admin Login
                    </button>
                    
                    <div class="text-center" style="margin-top: var(--spacing-md);">
                        <small class="text-muted">
                            Access restricted to authorized Events Committee members only
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Admin Content (Hidden until authenticated) -->
        <div id="adminMainContent" class="form-container" style="display: none;">
            
            <!-- Admin Dashboard Stats (Now Clickable!) -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                <div class="card clickable-stat-card" id="pendingStatsCard" data-filter="pending">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; color: var(--wm-warning); margin-bottom: var(--spacing-xs);" id="pendingCount">-</div>
                        <div class="text-muted">Pending Approvals</div>
                        <small class="text-muted">👆 Click to view</small>
                    </div>
                </div>
                <div class="card clickable-stat-card" id="approvedStatsCard" data-filter="approved">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; color: var(--wm-success); margin-bottom: var(--spacing-xs);" id="approvedCount">-</div>
                        <div class="text-muted">Approved Events</div>
                        <small class="text-muted">👆 Click to view</small>
                    </div>
                </div>
                <div class="card clickable-stat-card" id="todayStatsCard" data-filter="today">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; color: var(--wm-primary-green); margin-bottom: var(--spacing-xs);" id="todayCount">-</div>
                        <div class="text-muted">Events Today</div>
                        <small class="text-muted">👆 Click to view</small>
                    </div>
                </div>
                <div class="card clickable-stat-card" id="monthStatsCard" data-filter="month">
                    <div class="card-body text-center">
                        <div style="font-size: 2rem; color: var(--wm-accent-gold); margin-bottom: var(--spacing-xs);" id="monthCount">-</div>
                        <div class="text-muted">This Month</div>
                        <small class="text-muted">👆 Click to view</small>
                    </div>
                </div>
            </div>

            <!-- Enhanced Filters & Actions Bar -->
            <div class="card" style="margin-bottom: var(--spacing-xl);">
                <div class="card-body">
                    <div class="flex-between" style="flex-wrap: wrap; gap: var(--spacing-sm);">
                        <div>
                            <h3 class="text-primary" id="currentViewTitle">📋 Pending Event Approvals</h3>
                            <div id="activeFilters" style="margin-top: var(--spacing-xs);"></div>
                        </div>
                        <div class="flex-center gap-sm" style="flex-wrap: wrap;">
                            <div class="filter-group" style="display: flex; gap: var(--spacing-xs);">
                                <select id="eventTypeFilter" class="form-control" style="min-width: 150px;">
                                    <option value="">All Event Types</option>
                                    <option value="academic">Academic</option>
                                    <option value="social">Social</option>
                                    <option value="athletic">Athletic</option>
                                    <option value="meeting">Meeting</option>
                                    <option value="workshop">Workshop</option>
                                    <option value="other">Other</option>
                                </select>
                                <select id="dateRangeFilter" class="form-control" style="min-width: 150px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="tomorrow">Tomorrow</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="next-month">Next Month</option>
                                </select>
                                <button class="btn btn-outline" id="clearFiltersBtn">🔄 Clear</button>
                            </div>
                            <div class="action-group" style="display: flex; gap: var(--spacing-xs);">
                                <button class="btn btn-outline" id="refreshBtn">🔄 Refresh</button>
                                <button class="btn btn-success" id="approveAllBtn">✅ Approve All</button>
                                <button class="btn btn-secondary" id="systemHealthBtn">🏥 System Health</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="adminLoadingDiv">
                <div class="spinner"></div>
                <p>Loading admin panel...</p>
            </div>

            <!-- Main Events Container -->
            <div id="eventsDisplayContainer">
                <!-- Events will be populated here based on current view -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center" style="display: none; padding: var(--spacing-2xl);">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-lg);">📭</div>
                <h3 class="text-primary" id="emptyStateTitle">No Events Found</h3>
                <p class="text-muted" id="emptyStateMessage">No events match your current filters.</p>
                <button class="btn btn-primary" id="emptyStateAction">🔄 Refresh</button>
            </div>

            <!-- System Status Panel -->
            <div class="card" style="margin-top: var(--spacing-xl);">
                <div class="card-header">
                    <h4 class="card-title text-primary">🔧 System Status</h4>
                </div>
                <div class="card-body">
                    <div id="systemStatus">
                        <p class="text-muted">Click "System Health" to check system status</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">🔑 Admin Authentication</div>
                <div class="modal-subtitle">William & Mary Events Committee</div>
                <button class="modal-close" id="loginModalClose">×</button>
            </div>
            <div class="modal-body">
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label for="adminPassword">Administrator Password</label>
                        <input 
                            type="password" 
                            id="adminPassword" 
                            class="form-control" 
                            required 
                            placeholder="Enter admin password"
                            autocomplete="current-password"
                        >
                        <small class="text-muted">Contact Events Committee for access</small>
                    </div>

                    <div class="form-group">
                        <label for="githubToken">GitHub Access Token</label>
                        <input 
                            type="password" 
                            id="githubToken" 
                            class="form-control" 
                            required 
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                            autocomplete="off"
                        >
                        <small class="text-muted">
                            Required for managing event data. 
                            <a href="#" id="tokenHelpBtn" class="text-primary">Need help?</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberSession">
                            <span>Remember this session (24 hours)</span>
                        </label>
                    </div>

                    <div class="modal-actions" style="margin-top: var(--spacing-lg);">
                        <button type="button" class="btn btn-secondary" id="cancelLoginBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">🔓 Authenticate</button>
                    </div>
                </form>

                <!-- Connection Test Results -->
                <div id="connectionTest" style="display: none; margin-top: var(--spacing-lg);">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title">🔗 Connection Test</h6>
                        </div>
                        <div class="card-body">
                            <div id="connectionResults">
                                <p class="text-muted">Testing GitHub connection...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Action Modal (Approve/Reject) -->
    <div class="modal-overlay" id="eventActionModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="actionModalTitle">Event Action</div>
                <div class="modal-subtitle" id="actionModalSubtitle">Review event details</div>
                <button class="modal-close" id="actionModalClose">×</button>
            </div>
            <div class="modal-body">
                <div id="eventActionContent">
                    <!-- Event details will be populated here -->
                </div>
                <div class="modal-actions" style="margin-top: var(--spacing-lg);">
                    <button type="button" class="btn btn-secondary" id="cancelActionBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="rejectEventBtn" style="display: none;">❌ Reject</button>
                    <button type="button" class="btn btn-success" id="approveEventBtn" style="display: none;">✅ Approve</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div class="modal-overlay" id="rejectionModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">❌ Reject Event</div>
                <div class="modal-subtitle">Please provide a reason</div>
                <button class="modal-close" id="rejectionModalClose">×</button>
            </div>
            <div class="modal-body">
                <form id="rejectionForm">
                    <div class="form-group">
                        <label for="rejectionReason">Reason for Rejection</label>
                        <textarea 
                            id="rejectionReason" 
                            class="form-control" 
                            rows="4" 
                            required
                            placeholder="Please explain why this event is being rejected..."
                        ></textarea>
                    </div>
                    <div class="modal-actions" style="margin-top: var(--spacing-lg);">
                        <button type="button" class="btn btn-secondary" id="cancelRejectionBtn">Cancel</button>
                        <button type="submit" class="btn btn-danger">❌ Confirm Rejection</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Token Help Modal -->
    <div class="modal-overlay" id="tokenHelpModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">💡 GitHub Token Help</div>
                <div class="modal-subtitle">How to create your GitHub access token</div>
                <button class="modal-close" id="tokenHelpModalClose">×</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <h5 class="text-primary">🔧 Creating a GitHub Personal Access Token</h5>
                        <ol style="margin-left: var(--spacing-md); line-height: 1.8;">
                            <li>Go to <a href="https://github.com/settings/tokens" target="_blank" class="text-primary">GitHub Settings → Personal Access Tokens</a></li>
                            <li>Click <strong>"Generate new token (classic)"</strong></li>
                            <li>Set expiration to <strong>90 days</strong></li>
                            <li>Select these scopes:
                                <ul style="margin-top: var(--spacing-xs);">
                                    <li>✅ <strong>repo</strong> (Full control of private repositories)</li>
                                    <li>✅ <strong>workflow</strong> (Update GitHub Actions)</li>
                                </ul>
                            </li>
                            <li>Click <strong>"Generate token"</strong></li>
                            <li>Copy the token (starts with <code>ghp_</code>)</li>
                        </ol>
                        
                        <div style="background: var(--wm-gray-100); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-top: var(--spacing-md);">
                            <p class="text-warning" style="margin: 0;"><strong>⚠️ Important:</strong> Store your token securely. You won't be able to see it again!</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center" style="margin-top: var(--spacing-lg);">
                    <button class="btn btn-primary" id="closeTokenHelpBtn">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- W&M Footer -->
    <div class="footer">
        <div class="wm-branding">
            <p>
                &copy; 2024 AQEvent Admin Panel | 
                <a href="https://www.wm.edu" target="_blank" rel="noopener">The College of William & Mary</a> | 
                Authorized Personnel Only
            </p>
        </div>
    </div>

    <!-- Enhanced CSS for clickable stats -->
    <style>
        .clickable-stat-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .clickable-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .clickable-stat-card.active {
            border: 2px solid var(--wm-primary-green);
            background: var(--wm-primary-green-light);
        }
        
        .filter-group {
            align-items: center;
        }
        
        .active-filter-tag {
            display: inline-block;
            background: var(--wm-primary-green);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            margin-right: var(--spacing-xs);
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flex-center {
            display: flex;
            align-items: center;
        }
        
        .gap-sm {
            gap: var(--spacing-sm);
        }
    </style>

    <!-- JavaScript Dependencies -->
    <script src="js/github-api.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Enhanced Admin-Specific JavaScript -->
    <script>
        // ============================================================================
        // ENHANCED ADMIN PANEL WITH CLICKABLE STATS & FILTERING
        // ============================================================================

        // Admin state
        let currentEventForAction = null;
        let pendingEvents = [];
        let approvedEvents = [];
        let adminStats = { pending: 0, approved: 0, today: 0, thisMonth: 0 };
        let currentView = 'pending';
        let activeFilters = {
            eventType: '',
            dateRange: '',
            searchTerm: ''
        };

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            console.log('⚙️ Initializing Enhanced W&M Admin Panel...');
            initializeAdminPanel();
        });

        // Initialize admin panel
        async function initializeAdminPanel() {
            try {
                // Setup authentication
                setupAuthentication();
                
                // Check if already authenticated
                if (checkExistingAuth()) {
                    await showAdminPanel();
                } else {
                    showAuthRequired();
                }
                
                console.log('✅ Enhanced admin panel initialized');
                
            } catch (error) {
                console.error('❌ Admin panel initialization failed:', error);
                showError('Failed to initialize admin panel: ' + error.message);
            }
        }

        // Setup authentication system
        function setupAuthentication() {
            // Login modal events
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('loginModalClose').addEventListener('click', hideLoginModal);
            document.getElementById('cancelLoginBtn').addEventListener('click', hideLoginModal);
            document.getElementById('adminLoginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Token help
            document.getElementById('tokenHelpBtn').addEventListener('click', showTokenHelp);
            document.getElementById('tokenHelpModalClose').addEventListener('click', hideTokenHelp);
            document.getElementById('closeTokenHelpBtn').addEventListener('click', hideTokenHelp);
            
            // Test connection when token is entered
            document.getElementById('githubToken').addEventListener('input', debounce(testGitHubConnection, 1000));
            
            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                        this.classList.remove('show');
                    }
                });
            });
        }

        // Check existing authentication
        function checkExistingAuth() {
            const authData = window.GitHubAPI.getStoredAuthData();
            if (authData && window.GitHubAPI.validateAdminPassword(authData.password)) {
                console.log('✅ Found valid authentication');
                return true;
            }
            console.log('🔐 No valid authentication found');
            return false;
        }

        // Show authentication required screen
        function showAuthRequired() {
            document.getElementById('authRequiredContainer').style.display = 'block';
            document.getElementById('adminMainContent').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('loginModal').classList.add('show');
            document.getElementById('adminPassword').focus();
        }

        // Hide login modal
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginModal').classList.remove('show');
            document.getElementById('connectionTest').style.display = 'none';
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            const token = document.getElementById('githubToken').value;
            const remember = document.getElementById('rememberSession').checked;
            
            console.log('🔑 Attempting admin authentication...');
            
            // Validate password
            if (!window.GitHubAPI.validateAdminPassword(password)) {
                showNotification('Invalid administrator password', 'error');
                return;
            }
            
            // Validate token format
            if (!token.startsWith('ghp_') || token.length < 40) {
                showNotification('Please enter a valid GitHub token (starts with ghp_)', 'error');
                return;
            }
            
            try {
                // Store auth data
                window.GitHubAPI.storeAuthData(token, password);
                
                // Test GitHub connection
                const connectionTest = await window.GitHubAPI.testGitHubConnection();
                if (!connectionTest.success) {
                    showNotification('GitHub connection failed: ' + connectionTest.error, 'error');
                    window.GitHubAPI.clearAuthData();
                    return;
                }
                
                console.log('✅ Authentication successful');
                showNotification('Authentication successful! Welcome to the admin panel.', 'success');
                
                hideLoginModal();
                await showAdminPanel();
                
            } catch (error) {
                console.error('❌ Authentication error:', error);
                showNotification('Authentication failed: ' + error.message, 'error');
                window.GitHubAPI.clearAuthData();
            }
        }

        // Handle logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.GitHubAPI.clearAuthData();
                showNotification('Logged out successfully', 'info');
                showAuthRequired();
                console.log('🚪 Admin logged out');
            }
        }

        // Show admin panel
        async function showAdminPanel() {
            document.getElementById('authRequiredContainer').style.display = 'none';
            document.getElementById('adminMainContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            
            // Setup enhanced admin functionality
            setupEnhancedAdminControls();
            
            // Load admin data
            await loadAdminData();
        }

        // Setup enhanced admin controls
        function setupEnhancedAdminControls() {
            // Basic admin controls
            document.getElementById('refreshBtn').addEventListener('click', loadAdminData);
            document.getElementById('approveAllBtn').addEventListener('click', approveAllEvents);
            document.getElementById('systemHealthBtn').addEventListener('click', runSystemHealth);
            
            // Enhanced clickable stat cards
            document.getElementById('pendingStatsCard').addEventListener('click', () => switchView('pending'));
            document.getElementById('approvedStatsCard').addEventListener('click', () => switchView('approved'));
            document.getElementById('todayStatsCard').addEventListener('click', () => switchView('today'));
            document.getElementById('monthStatsCard').addEventListener('click', () => switchView('month'));
            
            // Filter controls
            document.getElementById('eventTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('dateRangeFilter').addEventListener('change', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('emptyStateAction').addEventListener('click', () => {
                clearFilters();
                loadAdminData();
            });
            
            // Event action modal
            document.getElementById('actionModalClose').addEventListener('click', hideEventActionModal);
            document.getElementById('cancelActionBtn').addEventListener('click', hideEventActionModal);
            document.getElementById('approveEventBtn').addEventListener('click', handleApproveEvent);
            document.getElementById('rejectEventBtn').addEventListener('click', showRejectionModal);
            
            // Rejection modal
            document.getElementById('rejectionModalClose').addEventListener('click', hideRejectionModal);
            document.getElementById('cancelRejectionBtn').addEventListener('click', hideRejectionModal);
            document.getElementById('rejectionForm').addEventListener('submit', handleRejectEvent);
        }

        // Load admin data
        async function loadAdminData() {
            try {
                showAdminLoading(true);
                
                console.log('📊 Loading enhanced admin data...');
                
                // Load both pending and approved events
                pendingEvents = await window.GitHubAPI.loadPendingEvents();
                approvedEvents = await window.GitHubAPI.loadApprovedEvents();
                
                console.log('📋 Loaded', pendingEvents.length, 'pending events');
                console.log('✅ Loaded', approvedEvents.length, 'approved events');
                
                // Calculate statistics
                calculateStats();
                
                // Update UI
                updateStatsDisplay();
                updateCurrentView();
                
                showAdminLoading(false);
                showNotification('Admin data loaded successfully', 'success');
                
            } catch (error) {
                showAdminLoading(false);
                console.error('❌ Error loading admin data:', error);
                showNotification('Error loading admin data: ' + error.message, 'error');
            }
        }

        // Calculate admin statistics
        function calculateStats() {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            adminStats.pending = pendingEvents.length;
            adminStats.approved = approvedEvents.length;
            
            // Events today (from approved events)
            adminStats.today = approvedEvents.filter(event => {
                const eventDate = new Date(event.eventDate || event.eventData?.eventDate);
                return eventDate.toDateString() === today.toDateString();
            }).length;
            
            // Events this month (from approved events)
            adminStats.thisMonth = approvedEvents.filter(event => {
                const eventDate = new Date(event.eventDate || event.eventData?.eventDate);
                return eventDate.getMonth() === thisMonth && eventDate.getFullYear() === thisYear;
            }).length;
        }

        // Update statistics display
        function updateStatsDisplay() {
            document.getElementById('pendingCount').textContent = adminStats.pending;
            document.getElementById('approvedCount').textContent = adminStats.approved;
            document.getElementById('todayCount').textContent = adminStats.today;
            document.getElementById('monthCount').textContent = adminStats.thisMonth;
            
            // Update active card styling
            document.querySelectorAll('.clickable-stat-card').forEach(card => {
                card.classList.toggle('active', card.dataset.filter === currentView);
            });
        }

        // Switch view based on stat card clicked
        function switchView(view) {
            currentView = view;
            updateCurrentView();
            updateStatsDisplay();
            
            // Clear filters when switching views
            clearFilters();
        }

        // Update current view display
        function updateCurrentView() {
            const titleElement = document.getElementById('currentViewTitle');
            let events = [];
            
            switch (currentView) {
                case 'pending':
                    titleElement.textContent = '📋 Pending Event Approvals';
                    events = pendingEvents;
                    document.getElementById('approveAllBtn').style.display = 'inline-flex';
                    break;
                    
                case 'approved':
                    titleElement.textContent = '✅ Approved Events';
                    events = approvedEvents;
                    document.getElementById('approveAllBtn').style.display = 'none';
                    break;
                    
                case 'today':
                    titleElement.textContent = '📅 Events Today';
                    events = getEventsForToday();
                    document.getElementById('approveAllBtn').style.display = 'none';
                    break;
                    
                case 'month':
                    titleElement.textContent = '📊 Events This Month';
                    events = getEventsForThisMonth();
                    document.getElementById('approveAllBtn').style.display = 'none';
                    break;
            }
            
            renderEvents(events);
        }

        // Get events for today
        function getEventsForToday() {
            const today = new Date();
            return approvedEvents.filter(event => {
                const eventDate = new Date(event.eventDate || event.eventData?.eventDate);
                return eventDate.toDateString() === today.toDateString();
            });
        }

        // Get events for this month
        function getEventsForThisMonth() {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            return approvedEvents.filter(event => {
                const eventDate = new Date(event.eventDate || event.eventData?.eventDate);
                return eventDate.getMonth() === thisMonth && eventDate.getFullYear() === thisYear;
            });
        }

        // Apply filters
        function applyFilters() {
            activeFilters.eventType = document.getElementById('eventTypeFilter').value;
            activeFilters.dateRange = document.getElementById('dateRangeFilter').value;
            
            updateActiveFiltersDisplay();
            updateCurrentView();
        }

        // Clear filters
        function clearFilters() {
            activeFilters.eventType = '';
            activeFilters.dateRange = '';
            activeFilters.searchTerm = '';
            
            document.getElementById('eventTypeFilter').value = '';
            document.getElementById('dateRangeFilter').value = '';
            
            updateActiveFiltersDisplay();
            updateCurrentView();
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            
            if (activeFilters.eventType) {
                filters.push(`Type: ${activeFilters.eventType}`);
            }
            if (activeFilters.dateRange) {
                filters.push(`Date: ${activeFilters.dateRange}`);
            }
            
            if (filters.length > 0) {
                container.innerHTML = filters.map(filter => 
                    `<span class="active-filter-tag">${filter}</span>`
                ).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // Filter events based on active filters
        function filterEvents(events) {
            return events.filter(event => {
                const eventData = event.eventData || event;
                
                // Event type filter
                if (activeFilters.eventType) {
                    const eventType = (eventData.eventType || '').toLowerCase();
                    if (!eventType.includes(activeFilters.eventType.toLowerCase())) {
                        return false;
                    }
                }
                
                // Date range filter
                if (activeFilters.dateRange) {
                    const eventDate = new Date(eventData.eventDate);
                    const today = new Date();
                    
                    switch (activeFilters.dateRange) {
                        case 'today':
                            if (eventDate.toDateString() !== today.toDateString()) return false;
                            break;
                        case 'tomorrow':
                            const tomorrow = new Date(today);
                            tomorrow.setDate(today.getDate() + 1);
                            if (eventDate.toDateString() !== tomorrow.toDateString()) return false;
                            break;
                        case 'week':
                            const weekEnd = new Date(today);
                            weekEnd.setDate(today.getDate() + 7);
                            if (eventDate < today || eventDate > weekEnd) return false;
                            break;
                        case 'month':
                            if (eventDate.getMonth() !== today.getMonth() || 
                                eventDate.getFullYear() !== today.getFullYear()) return false;
                            break;
                        case 'next-month':
                            const nextMonth = new Date(today);
                            nextMonth.setMonth(today.getMonth() + 1);
                            if (eventDate.getMonth() !== nextMonth.getMonth() || 
                                eventDate.getFullYear() !== nextMonth.getFullYear()) return false;
                            break;
                    }
                }
                
                return true;
            });
        }

        // Render events based on current view and filters
        function renderEvents(events) {
            const container = document.getElementById('eventsDisplayContainer');
            const emptyState = document.getElementById('emptyState');
            
            // Apply filters
            const filteredEvents = filterEvents(events);
            
            if (filteredEvents.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                
                // Update empty state based on current view
                const emptyTitle = document.getElementById('emptyStateTitle');
                const emptyMessage = document.getElementById('emptyStateMessage');
                
                if (currentView === 'pending') {
                    emptyTitle.textContent = '🎉 All Caught Up!';
                    emptyMessage.textContent = 'No pending events to review at this time.';
                } else {
                    emptyTitle.textContent = '📭 No Events Found';
                    emptyMessage.textContent = 'No events match your current filters.';
                }
                
                return;
            }
            
            emptyState.style.display = 'none';
            
            const eventsHTML = filteredEvents.map(event => createEventCard(event, currentView)).join('');
            container.innerHTML = eventsHTML;
        }

        // Create event card HTML (enhanced for different views)
        function createEventCard(event, viewType) {
            const eventData = event.eventData || event;
            const submittedDate = new Date(event.submittedAt || event.submittedDate || event.approvedAt || Date.now());
            
            // Different card styling based on view type
            let cardClass = 'card schedule-card';
            let actionButtons = '';
            
            if (viewType === 'pending') {
                cardClass += ' pending';
                actionButtons = `
                    <button class="btn btn-outline btn-sm" onclick="viewEventDetails('${event.id}')">👁️ View Details</button>
                    <button class="btn btn-danger btn-sm" onclick="rejectEvent('${event.id}')">❌ Reject</button>
                    <button class="btn btn-success btn-sm" onclick="approveEvent('${event.id}')">✅ Approve</button>
                `;
            } else {
                cardClass += ' approved';
                actionButtons = `
                    <button class="btn btn-outline btn-sm" onclick="viewEventDetails('${event.id}')">👁️ View Details</button>
                    <span class="text-success">✅ Approved</span>
                `;
            }
            
            return `
                <div class="${cardClass}" style="margin-bottom: var(--spacing-md);">
                    <div class="card-header">
                        <div class="flex-between">
                            <div>
                                <h4 class="card-title">${eventData.name || 'Unnamed Event'}</h4>
                                <div class="flex-center gap-sm">
                                    <span class="event-type-badge ${(eventData.eventType || '').toLowerCase().replace(/\s+/g, '-')}">${eventData.eventType || 'Unknown'}</span>
                                    <span class="text-muted">📅 ${window.AQEventUtils.DateUtils.formatAcademic(eventData.eventDate)}</span>
                                    <span class="text-muted">⏰ ${window.AQEventUtils.DateUtils.formatTime(eventData.eventStartTime)}</span>
                                    <span class="text-muted">📍 ${eventData.location}</span>
                                </div>
                            </div>
                            <div class="text-muted">
                                <small>${viewType === 'pending' ? 'Submitted' : 'Processed'}: ${submittedDate.toLocaleDateString()}</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <div>
                                <strong>Time:</strong><br>
                                ${window.AQEventUtils.DateUtils.formatTime(eventData.eventStartTime)} - ${window.AQEventUtils.DateUtils.formatTime(eventData.eventEndTime)}
                            </div>
                            <div>
                                <strong>Contact:</strong><br>
                                ${eventData.contactPerson}<br>
                                <a href="mailto:${eventData.contactEmail}" class="text-primary">${eventData.contactEmail}</a>
                            </div>
                            <div>
                                <strong>Staff:</strong><br>
                                ${eventData.staffWorkingEvent || 'Not specified'}
                            </div>
                        </div>
                        
                        ${eventData.description ? `<p><strong>Description:</strong> ${eventData.description}</p>` : ''}
                        
                        <div class="card-footer">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        }

        // Event action functions (unchanged)
        window.viewEventDetails = function(eventId) {
            const event = findEventById(eventId);
            if (event) {
                showEventActionModal(event, 'view');
            }
        };

        window.approveEvent = function(eventId) {
            const event = findEventById(eventId);
            if (event) {
                showEventActionModal(event, 'approve');
            }
        };

        window.rejectEvent = function(eventId) {
            const event = findEventById(eventId);
            if (event) {
                showEventActionModal(event, 'reject');
            }
        };

        // Find event by ID across all collections
        function findEventById(eventId) {
            return pendingEvents.find(e => e.id === eventId) || 
                   approvedEvents.find(e => e.id === eventId);
        }

        // Show event action modal (unchanged)
        function showEventActionModal(event, action) {
            currentEventForAction = event;
            const eventData = event.eventData || event;
            
            document.getElementById('actionModalTitle').textContent = eventData.name;
            document.getElementById('actionModalSubtitle').textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} Event`;
            
            const content = `
                <div style="display: grid; gap: var(--spacing-sm);">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-primary">📋 Event Details</h6>
                            <p><strong>Date:</strong> ${window.AQEventUtils.DateUtils.formatAcademic(eventData.eventDate)}</p>
                            <p><strong>Time:</strong> ${window.AQEventUtils.DateUtils.formatTime(eventData.eventStartTime)} - ${window.AQEventUtils.DateUtils.formatTime(eventData.eventEndTime)}</p>
                            <p><strong>Location:</strong> ${eventData.location}</p>
                            <p><strong>Type:</strong> ${eventData.eventType}</p>
                            ${eventData.description ? `<p><strong>Description:</strong> ${eventData.description}</p>` : ''}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-primary">👤 Contact Information</h6>
                            <p><strong>Contact:</strong> ${eventData.contactPerson}</p>
                            <p><strong>Email:</strong> <a href="mailto:${eventData.contactEmail}">${eventData.contactEmail}</a></p>
                            <p><strong>Phone:</strong> ${eventData.contactNumber}</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-primary">👥 Staff & Logistics</h6>
                            <p><strong>Staff:</strong> ${eventData.staffWorkingEvent}</p>
                            ${eventData.neededLogistics ? `<p><strong>Logistics:</strong> ${eventData.neededLogistics}</p>` : ''}
                            ${eventData.studentEmployeesNeeded === 'Yes' ? `<p><strong>Students Needed:</strong> ${eventData.numberOfStudentsNeeded || 'Not specified'}</p>` : ''}
                            ${eventData.assignedStudents ? `<p><strong>Assigned Students:</strong> ${eventData.assignedStudents}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('eventActionContent').innerHTML = content;
            
            // Show/hide action buttons based on current view
            const isApproved = currentView !== 'pending';
            document.getElementById('approveEventBtn').style.display = (!isApproved && action === 'approve') ? 'inline-flex' : 'none';
            document.getElementById('rejectEventBtn').style.display = (!isApproved && action === 'reject') ? 'inline-flex' : 'none';
            
            document.getElementById('eventActionModal').style.display = 'flex';
            document.getElementById('eventActionModal').classList.add('show');
        }

        // Hide event action modal
        function hideEventActionModal() {
            document.getElementById('eventActionModal').style.display = 'none';
            document.getElementById('eventActionModal').classList.remove('show');
            currentEventForAction = null;
        }

        // Handle approve event
        async function handleApproveEvent() {
            if (!currentEventForAction) return;
            
            try {
                showNotification('Approving event...', 'info');
                
                const result = await window.GitHubAPI.approveEvent(currentEventForAction.id);
                
                if (result.success) {
                    showNotification('Event approved successfully! 🎉', 'success');
                    hideEventActionModal();
                    await loadAdminData();
                } else {
                    showNotification('Error approving event: ' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error approving event:', error);
                showNotification('Error approving event: ' + error.message, 'error');
            }
        }

        // Show rejection modal
        function showRejectionModal() {
            hideEventActionModal();
            document.getElementById('rejectionModal').style.display = 'flex';
            document.getElementById('rejectionModal').classList.add('show');
            document.getElementById('rejectionReason').focus();
        }

        // Hide rejection modal
        function hideRejectionModal() {
            document.getElementById('rejectionModal').style.display = 'none';
            document.getElementById('rejectionModal').classList.remove('show');
            document.getElementById('rejectionReason').value = '';
        }

        // Handle reject event
        async function handleRejectEvent(event) {
            event.preventDefault();
            
            if (!currentEventForAction) return;
            
            const reason = document.getElementById('rejectionReason').value.trim();
            if (!reason) {
                showNotification('Please provide a reason for rejection', 'warning');
                return;
            }
            
            try {
                showNotification('Rejecting event...', 'info');
                
                const result = await window.GitHubAPI.rejectEvent(currentEventForAction.id, reason);
                
                if (result.success) {
                    showNotification('Event rejected successfully', 'success');
                    hideRejectionModal();
                    await loadAdminData();
                } else {
                    showNotification('Error rejecting event: ' + result.message, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error rejecting event:', error);
                showNotification('Error rejecting event: ' + error.message, 'error');
            }
        }

        // Approve all events
        async function approveAllEvents() {
            const eventsToApprove = filterEvents(pendingEvents);
            
            if (eventsToApprove.length === 0) {
                showNotification('No pending events to approve', 'info');
                return;
            }
            
            if (!confirm(`Are you sure you want to approve all ${eventsToApprove.length} filtered pending events?`)) {
                return;
            }
            
            showNotification(`Approving ${eventsToApprove.length} events...`, 'info');
            
            let approved = 0;
            let errors = 0;
            
            for (const event of eventsToApprove) {
                try {
                    const result = await window.GitHubAPI.approveEvent(event.id);
                    if (result.success) {
                        approved++;
                    } else {
                        errors++;
                    }
                } catch (error) {
                    errors++;
                    console.error('Error approving event:', error);
                }
            }
            
            const message = errors === 0 ? 
                `Successfully approved all ${approved} events! 🎉` :
                `Approved ${approved} events. ${errors} failed.`;
            
            showNotification(message, errors === 0 ? 'success' : 'warning');
            await loadAdminData();
        }

        // Run system health check
        async function runSystemHealth() {
            try {
                showNotification('Running system health check...', 'info');
                
                const health = await window.GitHubAPI.testGitHubConnection();
                const statusElement = document.getElementById('systemStatus');
                
                if (health.success) {
                    statusElement.innerHTML = `
                        <div class="text-success">
                            <h6>✅ System Healthy</h6>
                            <p>GitHub API: Connected</p>
                            <p>Repository: ${health.details?.full_name || 'Accessible'}</p>
                            <p>Events: ${pendingEvents.length} pending, ${approvedEvents.length} approved</p>
                            <p>Last Check: ${new Date().toLocaleString()}</p>
                        </div>
                    `;
                    showNotification('✅ System health check passed', 'success');
                } else {
                    statusElement.innerHTML = `
                        <div class="text-error">
                            <h6>❌ System Issues</h6>
                            <p>Error: ${health.error}</p>
                            <p>Last Check: ${new Date().toLocaleString()}</p>
                        </div>
                    `;
                    showNotification('❌ System health check failed', 'error');
                }
                
            } catch (error) {
                console.error('❌ Health check error:', error);
                showNotification('Health check failed: ' + error.message, 'error');
            }
        }

        // Test GitHub connection
        async function testGitHubConnection() {
            const token = document.getElementById('githubToken').value;
            if (!token || !token.startsWith('ghp_')) return;
            
            const testDiv = document.getElementById('connectionTest');
            const resultsDiv = document.getElementById('connectionResults');
            
            testDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p class="text-muted">Testing GitHub connection...</p>';
            
            try {
                // Temporarily store token for testing
                const originalAuth = window.GitHubAPI.getStoredAuthData();
                window.GitHubAPI.storeAuthData(token, 'temp');
                
                const result = await window.GitHubAPI.testGitHubConnection();
                
                if (result.success) {
                    resultsDiv.innerHTML = `
                        <p class="text-success">✅ Connection successful!</p>
                        <small class="text-muted">Repository: ${result.details?.full_name || 'Connected'}</small>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <p class="text-error">❌ Connection failed</p>
                        <small class="text-muted">${result.error}</small>
                    `;
                }
                
                // Restore original auth
                if (originalAuth) {
                    window.GitHubAPI.storeAuthData(originalAuth.token, originalAuth.password);
                } else {
                    window.GitHubAPI.clearAuthData();
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <p class="text-error">❌ Connection error</p>
                    <small class="text-muted">${error.message}</small>
                `;
            }
        }

        // Show token help
        function showTokenHelp() {
            document.getElementById('tokenHelpModal').style.display = 'flex';
            document.getElementById('tokenHelpModal').classList.add('show');
        }

        // Hide token help
        function hideTokenHelp() {
            document.getElementById('tokenHelpModal').style.display = 'none';
            document.getElementById('tokenHelpModal').classList.remove('show');
        }

        // Show admin loading
        function showAdminLoading(show) {
            const loadingDiv = document.getElementById('adminLoadingDiv');
            if (show) {
                loadingDiv.style.display = 'block';
            } else {
                loadingDiv.style.display = 'none';
            }
        }

        // Show notification (using global function)
        function showNotification(message, type) {
            window.AQEventUtils.showNotification(message, type);
        }

        // Show error
        function showError(message) {
            console.error('Admin Error:', message);
            showNotification(message, 'error');
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        console.log('⚙️ Enhanced admin panel JavaScript loaded');
    </script>
</body>
</html>
