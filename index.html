<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Event - AQEvent | William & Mary</title>
    <meta name="description" content="Submit an event for approval at William & Mary using the AQEvent scheduling platform.">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='80'%3Eüéì%3C/text%3E%3C/svg%3E">
</head>
<body>
    <div class="container">
        <!-- W&M Branded Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>üéì Schedule New Event</h1>
                    <p>Submit your event for approval at William & Mary</p>
                </div>
                <div class="header-right">
                    <a href="?page=calendar" class="nav-btn">üìÖ View Calendar</a>
                    <a href="?page=admin" class="nav-btn">‚öôÔ∏è Admin Panel</a>
                </div>
            </div>
        </div>

        <!-- Main Form Container -->
        <div class="form-container">
            <!-- Dynamic Message Container -->
            <div id="messageContainer"></div>

            <!-- Event Submission Form -->
            <form id="eventForm" novalidate>
                <div class="form-grid">
                    
                    <!-- Basic Event Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">üìã Basic Information</h3>
                        
                        <div class="form-group">
                            <label for="eventName">
                                Event Name <span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="eventName" 
                                class="form-control" 
                                required 
                                placeholder="Enter the name of your event"
                                maxlength="100"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="eventDate">
                                Event Date <span class="required">*</span>
                            </label>
                            <input 
                                type="date" 
                                id="eventDate" 
                                class="form-control" 
                                required
                            >
                            <small class="text-muted">Must be within the 2025-2026 academic year</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">
                                Location <span class="required">*</span>
                            </label>
                            <select id="location" class="form-control" required>
                                <option value="">Select a location</option>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="eventType">
                                Event Type <span class="required">*</span>
                            </label>
                            <select id="eventType" class="form-control" required>
                                <option value="">Select event type</option>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea 
                                id="description" 
                                class="form-control" 
                                rows="4" 
                                placeholder="Provide a brief description of your event"
                                maxlength="500"
                            ></textarea>
                            <small class="text-muted">Optional: Provide additional details about your event</small>
                        </div>
                    </div>
                    
                    <!-- Timing Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">‚è∞ Timing Details</h3>
                        
                        <div class="form-group">
                            <label>Reservation Time <span class="required">*</span></label>
                            <small class="text-muted">Time needed for setup and cleanup</small>
                            <div class="time-grid">
                                <div>
                                    <label for="reservationStartTime">Start Time</label>
                                    <input 
                                        type="time" 
                                        id="reservationStartTime" 
                                        class="form-control" 
                                        required
                                    >
                                </div>
                                <div>
                                    <label for="reservationEndTime">End Time</label>
                                    <input 
                                        type="time" 
                                        id="reservationEndTime" 
                                        class="form-control" 
                                        required
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Actual Event Time <span class="required">*</span></label>
                            <small class="text-muted">When your event actually starts and ends</small>
                            <div class="time-grid">
                                <div>
                                    <label for="eventStartTime">Start Time</label>
                                    <input 
                                        type="time" 
                                        id="eventStartTime" 
                                        class="form-control" 
                                        required
                                    >
                                </div>
                                <div>
                                    <label for="eventEndTime">End Time</label>
                                    <input 
                                        type="time" 
                                        id="eventEndTime" 
                                        class="form-control" 
                                        required
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Academic Time Slot Helper -->
                        <div class="card" style="margin-top: var(--spacing-sm);">
                            <div class="card-body">
                                <h6 class="card-title text-primary">üí° Academic Time Slots</h6>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-sm); font-size: var(--font-size-sm);">
                                    <div><strong>Morning:</strong> 8:00 AM - 12:00 PM</div>
                                    <div><strong>Afternoon:</strong> 12:00 PM - 5:00 PM</div>
                                    <div><strong>Evening:</strong> 5:00 PM - 10:00 PM</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">üìû Contact Information</h3>
                        
                        <div class="form-group">
                            <label for="contactPerson">
                                Contact Person <span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="contactPerson" 
                                class="form-control" 
                                required 
                                placeholder="Full name of primary contact"
                                maxlength="100"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="contactNumber">
                                Contact Number <span class="required">*</span>
                            </label>
                            <input 
                                type="tel" 
                                id="contactNumber" 
                                class="form-control" 
                                required 
                                placeholder="(757) 123-4567"
                            >
                            <small class="text-muted">Phone number for event coordination</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="contactEmail">
                                Contact Email <span class="required">*</span>
                            </label>
                            <input 
                                type="email" 
                                id="contactEmail" 
                                class="form-control" 
                                required 
                                placeholder="username@wm.edu"
                            >
                            <small class="text-muted">We recommend using your William & Mary email address</small>
                        </div>
                    </div>
                    
                    <!-- Staff and Logistics Section -->
                    <div class="form-section">
                        <h3 class="section-title">üë• Staff & Logistics</h3>
                        
                        <div class="form-group">
                            <label for="staffWorkingEvent">
                                Staff Working the Event <span class="required">*</span>
                            </label>
                            <textarea 
                                id="staffWorkingEvent" 
                                class="form-control" 
                                rows="3" 
                                required
                                placeholder="Enter staff names (comma-separated)"
                                maxlength="300"
                            ></textarea>
                            <small class="text-muted">List all staff members who will be working at this event</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="neededLogistics">Needed Logistics</label>
                            <textarea 
                                id="neededLogistics" 
                                class="form-control" 
                                rows="3" 
                                placeholder="List any special equipment, setup requirements, etc."
                                maxlength="500"
                            ></textarea>
                            <small class="text-muted">Optional: Describe any special equipment or setup needs</small>
                        </div>
                        
                        <!-- Student Employee Toggle -->
                        <div class="form-group">
                            <label>Student Employees Needed <span class="required">*</span></label>
                            <div class="toggle-container">
                                <span>No</span>
                                <div class="toggle-switch" id="studentToggle">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span>Yes</span>
                            </div>
                        </div>
                        
                        <!-- Number of Students (Hidden Initially) -->
                        <div class="form-group d-none" id="numberOfStudentsGroup">
                            <label for="numberOfStudents">Number of Students Needed</label>
                            <input 
                                type="number" 
                                id="numberOfStudents" 
                                class="form-control" 
                                min="1" 
                                max="50" 
                                placeholder="Enter number"
                            >
                            <small class="text-muted">How many student employees do you need?</small>
                        </div>
                        
                        <!-- Student Assignment -->
                        <div class="form-group">
                            <label for="assignedStudents">Assigned Students</label>
                            <div class="student-input-container" style="position: relative;">
                                <input 
                                    type="text" 
                                    id="assignedStudents" 
                                    class="form-control" 
                                    placeholder="Type student name and press Enter"
                                >
                                <!-- Autocomplete dropdown will be added by JavaScript -->
                            </div>
                            <!-- Student chips container will be added by JavaScript -->
                            <small class="text-muted">Optional: Pre-assign specific students to this event</small>
                        </div>
                    </div>
                    
                    <!-- Submission Section -->
                    <div class="form-section" style="grid-column: 1 / -1;">
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-xl" id="submitBtn">
                                üì§ Submit Event for Approval
                            </button>
                            
                            <div class="loading" id="loadingDiv">
                                <div class="spinner"></div>
                                <p>Submitting your event...</p>
                            </div>
                            
                            <div style="margin-top: var(--spacing-sm);">
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    üîÑ Reset Form
                                </button>
                                <button type="button" class="btn btn-outline" id="previewBtn">
                                    üëÅÔ∏è Preview Event
                                </button>
                            </div>
                        </div>
                        
                        <!-- W&M Academic Notice -->
                        <div class="card" style="margin-top: var(--spacing-lg); background: var(--wm-gray-100);">
                            <div class="card-body text-center">
                                <h6 class="text-primary">üìã Submission Process</h6>
                                <p class="text-muted" style="margin: 0; font-size: var(--font-size-sm);">
                                    Your event will be reviewed by the Events Committee. 
                                    You'll receive an email notification once your event is approved or if changes are needed.
                                    <strong>Processing time:</strong> 1-3 business days.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Preview Modal -->
    <div class="modal-overlay" id="previewModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">üëÅÔ∏è Event Preview</div>
                <div class="modal-subtitle">Review your event before submission</div>
                <button class="modal-close" id="previewModalClose">√ó</button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be populated by JavaScript -->
                </div>
                <div class="modal-actions" style="margin-top: var(--spacing-lg); text-align: center;">
                    <button class="btn btn-secondary" id="editPreviewBtn">‚úèÔ∏è Edit Event</button>
                    <button class="btn btn-primary" id="submitFromPreviewBtn">üì§ Submit Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- W&M Footer -->
    <div class="footer">
        <div class="wm-branding">
            <p>
                &copy; 2024 AQEvent Scheduler | 
                <a href="https://www.wm.edu" target="_blank" rel="noopener">The College of William & Mary</a> | 
                For support, contact your Events Committee
            </p>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="js/github-api.js"></script>
    <script src="js/app.js"></script>
    
    <!-- Form-Specific JavaScript -->
    <script>
        // ============================================================================
        // EVENT FORM SPECIFIC FUNCTIONALITY
        // ============================================================================

        // Initialize form when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìù Initializing W&M Event Submission Form...');
            
            // Wait for app.js to initialize
            if (window.AQEvent && window.AQEvent.app.isInitialized) {
                setupFormSpecificFeatures();
            } else {
                // Wait for initialization
                const checkInit = setInterval(() => {
                    if (window.AQEvent && window.AQEvent.app.isInitialized) {
                        clearInterval(checkInit);
                        setupFormSpecificFeatures();
                    }
                }, 100);
            }
        });

        // Setup form-specific features
        function setupFormSpecificFeatures() {
            setupStudentToggle();
            setupEventPreview();
            setupTimeHelpers();
            setupFormAutoSave();
            
            console.log('‚úÖ Event form ready!');
        }

        // Setup student employee toggle
        function setupStudentToggle() {
            const toggle = document.getElementById('studentToggle');
            const numberGroup = document.getElementById('numberOfStudentsGroup');
            
            if (toggle && numberGroup) {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    
                    if (this.classList.contains('active')) {
                        numberGroup.classList.remove('d-none');
                        numberGroup.style.animation = 'slideDown 0.3s ease';
                        document.getElementById('numberOfStudents').focus();
                    } else {
                        numberGroup.classList.add('d-none');
                        document.getElementById('numberOfStudents').value = '';
                    }
                });
            }
        }

        // Setup event preview functionality
        function setupEventPreview() {
            const previewBtn = document.getElementById('previewBtn');
            const previewModal = document.getElementById('previewModal');
            const previewModalClose = document.getElementById('previewModalClose');
            const editBtn = document.getElementById('editPreviewBtn');
            const submitFromPreviewBtn = document.getElementById('submitFromPreviewBtn');

            if (previewBtn) {
                previewBtn.addEventListener('click', showEventPreview);
            }

            if (previewModalClose) {
                previewModalClose.addEventListener('click', closeEventPreview);
            }

            if (editBtn) {
                editBtn.addEventListener('click', closeEventPreview);
            }

            if (submitFromPreviewBtn) {
                submitFromPreviewBtn.addEventListener('click', function() {
                    closeEventPreview();
                    document.getElementById('eventForm').dispatchEvent(new Event('submit'));
                });
            }

            // Close on overlay click
            if (previewModal) {
                previewModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeEventPreview();
                    }
                });
            }
        }

        // Show event preview
        function showEventPreview() {
            const formData = collectCurrentFormData();
            const previewContent = document.getElementById('previewContent');
            const previewModal = document.getElementById('previewModal');

            if (!formData.name) {
                window.AQEventUtils.showNotification('Please enter an event name to preview', 'warning');
                return;
            }

            // Generate preview HTML
            const previewHTML = generateEventPreviewHTML(formData);
            previewContent.innerHTML = previewHTML;
            
            // Show modal
            previewModal.classList.add('show');
            previewModal.style.display = 'flex';
        }

        // Close event preview
        function closeEventPreview() {
            const previewModal = document.getElementById('previewModal');
            previewModal.classList.remove('show');
            previewModal.style.display = 'none';
        }

        // Generate preview HTML
        function generateEventPreviewHTML(data) {
            const selectedStudents = Array.from(document.querySelectorAll('.chip'))
                .map(chip => chip.textContent.replace('√ó', '').trim());

            return `
                <div class="event-detail-grid" style="display: grid; gap: var(--spacing-sm);">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title text-primary">üìã Basic Information</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Event Name:</strong> ${data.name || 'Not specified'}</p>
                            <p><strong>Date:</strong> ${data.eventDate ? window.AQEventUtils.DateUtils.formatAcademic(data.eventDate) : 'Not specified'}</p>
                            <p><strong>Location:</strong> ${data.location || 'Not specified'}</p>
                            <p><strong>Type:</strong> ${data.eventType || 'Not specified'}</p>
                            ${data.description ? `<p><strong>Description:</strong> ${data.description}</p>` : ''}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title text-primary">‚è∞ Timing</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Reservation:</strong> ${data.reservationStartTime ? window.AQEventUtils.DateUtils.formatTime(data.reservationStartTime) : 'Not specified'} - ${data.reservationEndTime ? window.AQEventUtils.DateUtils.formatTime(data.reservationEndTime) : 'Not specified'}</p>
                            <p><strong>Event:</strong> ${data.eventStartTime ? window.AQEventUtils.DateUtils.formatTime(data.eventStartTime) : 'Not specified'} - ${data.eventEndTime ? window.AQEventUtils.DateUtils.formatTime(data.eventEndTime) : 'Not specified'}</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title text-primary">üìû Contact</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Contact Person:</strong> ${data.contactPerson || 'Not specified'}</p>
                            <p><strong>Phone:</strong> ${data.contactNumber || 'Not specified'}</p>
                            <p><strong>Email:</strong> ${data.contactEmail || 'Not specified'}</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title text-primary">üë• Staff & Students</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Staff:</strong> ${data.staffWorkingEvent || 'Not specified'}</p>
                            <p><strong>Students Needed:</strong> ${document.getElementById('studentToggle').classList.contains('active') ? 'Yes' : 'No'}</p>
                            ${document.getElementById('studentToggle').classList.contains('active') ? 
                                `<p><strong>Number of Students:</strong> ${data.numberOfStudentsNeeded || 'Not specified'}</p>` : ''}
                            ${selectedStudents.length > 0 ? 
                                `<p><strong>Assigned Students:</strong> ${selectedStudents.join(', ')}</p>` : ''}
                            ${data.neededLogistics ? `<p><strong>Logistics:</strong> ${data.neededLogistics}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Collect current form data
        function collectCurrentFormData() {
            return {
                name: document.getElementById('eventName')?.value || '',
                eventDate: document.getElementById('eventDate')?.value || '',
                location: document.getElementById('location')?.value || '',
                eventType: document.getElementById('eventType')?.value || '',
                description: document.getElementById('description')?.value || '',
                reservationStartTime: document.getElementById('reservationStartTime')?.value || '',
                reservationEndTime: document.getElementById('reservationEndTime')?.value || '',
                eventStartTime: document.getElementById('eventStartTime')?.value || '',
                eventEndTime: document.getElementById('eventEndTime')?.value || '',
                contactPerson: document.getElementById('contactPerson')?.value || '',
                contactNumber: document.getElementById('contactNumber')?.value || '',
                contactEmail: document.getElementById('contactEmail')?.value || '',
                staffWorkingEvent: document.getElementById('staffWorkingEvent')?.value || '',
                neededLogistics: document.getElementById('neededLogistics')?.value || '',
                numberOfStudentsNeeded: document.getElementById('numberOfStudents')?.value || 0
            };
        }

        // Setup time helpers
        function setupTimeHelpers() {
            // Auto-suggest event times based on reservation
            const reservationStart = document.getElementById('reservationStartTime');
            const reservationEnd = document.getElementById('reservationEndTime');
            const eventStart = document.getElementById('eventStartTime');
            const eventEnd = document.getElementById('eventEndTime');

            if (reservationStart && eventStart) {
                reservationStart.addEventListener('change', function() {
                    if (this.value && !eventStart.value) {
                        // Suggest event start 15 minutes after reservation start
                        const [hours, minutes] = this.value.split(':');
                        const suggestedTime = new Date();
                        suggestedTime.setHours(parseInt(hours), parseInt(minutes) + 15);
                        
                        eventStart.value = suggestedTime.toTimeString().slice(0, 5);
                    }
                });
            }

            if (reservationEnd && eventEnd) {
                reservationEnd.addEventListener('change', function() {
                    if (this.value && !eventEnd.value) {
                        // Suggest event end 15 minutes before reservation end
                        const [hours, minutes] = this.value.split(':');
                        const suggestedTime = new Date();
                        suggestedTime.setHours(parseInt(hours), parseInt(minutes) - 15);
                        
                        eventEnd.value = suggestedTime.toTimeString().slice(0, 5);
                    }
                });
            }
        }

        // Setup form auto-save (local storage)
        function setupFormAutoSave() {
            const form = document.getElementById('eventForm');
            const inputs = form.querySelectorAll('input, select, textarea');

            // Load saved data
            loadFormData();

            // Save data on input
            inputs.forEach(input => {
                input.addEventListener('input', debounce(saveFormData, 1000));
            });

            // Clear saved data on successful submission
            form.addEventListener('submit', function() {
                clearSavedFormData();
            });
        }

        // Save form data to localStorage
        function saveFormData() {
            const formData = collectCurrentFormData();
            localStorage.setItem('aqevent_form_draft', JSON.stringify(formData));
            console.log('üíæ Form data auto-saved');
        }

        // Load form data from localStorage
        function loadFormData() {
            try {
                const saved = localStorage.getItem('aqevent_form_draft');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Populate form fields
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(key === 'name' ? 'eventName' : key);
                        if (element && data[key]) {
                            element.value = data[key];
                        }
                    });

                    console.log('üìÑ Loaded saved form data');
                    window.AQEventUtils.showNotification('Restored your previous draft', 'info');
                }
            } catch (error) {
                console.error('Error loading saved form data:', error);
            }
        }

        // Clear saved form data
        function clearSavedFormData() {
            localStorage.removeItem('aqevent_form_draft');
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced form reset
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All unsaved data will be lost.')) {
                document.getElementById('eventForm').reset();
                
                // Reset student chips
                const chips = document.querySelector('.student-chips');
                if (chips) chips.innerHTML = '';
                
                // Reset toggle
                const toggle = document.getElementById('studentToggle');
                if (toggle) toggle.classList.remove('active');
                
                const numberGroup = document.getElementById('numberOfStudentsGroup');
                if (numberGroup) numberGroup.classList.add('d-none');
                
                // Clear saved data
                clearSavedFormData();
                
                window.AQEventUtils.showNotification('Form reset successfully', 'success');
            }
        }

        // Make resetForm available globally
        window.resetForm = resetForm;

        console.log('üìù Event submission form JavaScript loaded');

        <!-- Add these BEFORE your existing scripts -->
        <script src="js/conflict-detection.js"></script>
        <script src="js/conflict-ui.js"></script>
        
        <!-- Your existing scripts -->
        <script src="js/github-api.js"></script>
        <script src="js/app.js"></script>
    </script>
</body>
</html>
